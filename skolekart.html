import folium
from folium import plugins
from folium.plugins import AntPath
import requests
import time
import json
from pathlib import Path
from datetime import datetime

def get_school_coordinates(school_name):
    """Get school coordinates using Nominatim"""
    # Add Tromsø to make the search more precise
    search_query = f"{school_name}, Tromsø, Norway"
    
    # Add a small delay to respect Nominatim's usage policy
    time.sleep(1)
    
    url = f"https://nominatim.openstreetmap.org/search?q={search_query}&format=json&limit=1"
    headers = {'User-Agent': 'SchoolMapProject/1.0'}
    
    try:
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            results = response.json()
            if results:
                return float(results[0]['lat']), float(results[0]['lon'])
    except Exception as e:
        print(f"Error getting coordinates for {school_name}: {e}")
    return None

def get_route_coordinates(start_lat, start_lon, end_lat, end_lon):
    """Get route coordinates using OSRM"""
    # OSRM expects coordinates in lon,lat order
    url = f"http://router.project-osrm.org/route/v1/driving/{start_lon},{start_lat};{end_lon},{end_lat}?overview=full&geometries=geojson"
    
    try:
        response = requests.get(url)
        if response.status_code == 200:
            data = response.json()
            if 'routes' in data and len(data['routes']) > 0:
                route = data['routes'][0]
                coordinates = route['geometry']['coordinates']
                duration_minutes = round(route['duration'] / 60)  # Convert seconds to minutes
                distance_km = round(route['distance'] / 1000, 1)  # Convert meters to kilometers
                return {
                    "coordinates": coordinates,  # Already in lon,lat order as returned by OSRM
                    "duration": duration_minutes,
                    "distance": distance_km
                }
    except Exception as e:
        print(f"Error getting route: {e}")
    return None

# School statistics data
school_stats = {
    "Brensholmen skole": {
        "capacity": "100",
        "students_2023": "55",
        "students_2030": "49",
        "students_2040": "Ingen data",
        "students_2050": "Ingen data",
        "cost_per_student": "177 231 (har delt budsjett med Kattfjord skole, som hadde 11 elever i 2023)"
    },
    "Ersfjordbotn skole": {  # Listed as "Ersfjord" in data
        "capacity": "Ingen data",
        "students_2023": "38",
        "students_2030": "44",
        "students_2040": "Ingen data",
        "students_2050": "Ingen data",
        "cost_per_student": "190 063"
    },
    "Hamna skole": {
        "capacity": "380",
        "students_2023": "192 (51%)",
        "students_2030": "190 (50%)",
        "students_2040": "192 (51%)",
        "students_2050": "186 (49%)",
        "cost_per_student": "108 902"
    },
    "Kattfjord skole": {
        "capacity": "Ingen data",
        "students_2023": "11",
        "students_2030": "8",
        "students_2040": "Ingen data",
        "students_2050": "Ingen data",
        "cost_per_student": "177 231 (har delt budsjett med Brensholmen skole, som hadde 55 elever i 2023)"
    },
    "Krokelvdalen skole": {  # Listed as "Krokelvdal" in data
        "capacity": "300",
        "students_2023": "174 (58%)",
        "students_2030": "161 (54%)",
        "students_2040": "195 (65%)",
        "students_2050": "188 (63%)",
        "cost_per_student": "122 106"
    },
    "Lunheim skole": {
        "capacity": "380",
        "students_2023": "289 (76%)",
        "students_2030": "270 (71%)",
        "students_2040": "293 (77%)",
        "students_2050": "283 (74%)",
        "cost_per_student": "89 143"
    },
    "Sandnessund skole": {
        "capacity": "224",
        "students_2023": "118 (53%)",
        "students_2030": "89 (40%)",
        "students_2040": "115 (51%)",
        "students_2050": "179 (80%)",
        "cost_per_student": "109 511"
    },
    "Slettaelva skole": {
        "capacity": "310",
        "students_2023": "202 (65%)",
        "students_2030": "146 (47%)",
        "students_2040": "156 (50%)",
        "students_2050": "162 (52%)",
        "cost_per_student": "87 677"
    },
    "Solneset skole": {
        "capacity": "350",
        "students_2023": "184 (53%)",
        "students_2030": "191 (55%)",
        "students_2040": "207 (59%)",
        "students_2050": "200 (57%)",
        "cost_per_student": "92 137"
    },
    "Storelva skole": {
        "capacity": "480",
        "students_2023": "365 (76%)",
        "students_2030": "200 (42%)",
        "students_2040": "216 (45%)",
        "students_2050": "211 (44%)",
        "cost_per_student": "101 656"
    },
    "Straumsbukta skole": {
        "capacity": "100",
        "students_2023": "77",
        "students_2030": "59",
        "students_2040": "Ingen data",
        "students_2050": "Ingen data",
        "cost_per_student": "129 575"
    },
    "Tromsdalen skole": {  # Listed as "Tromsdal" in data
        "capacity": "620",
        "students_2023": "426 (69%)",
        "students_2030": "375 (60%)",
        "students_2040": "390 (63%)",
        "students_2050": "390 (63%)",
        "cost_per_student": "95 823"
    },
    "Trondjord skole": {
        "capacity": "80",
        "students_2023": "29",
        "students_2030": "35",
        "students_2040": "Ingen data",
        "students_2050": "Ingen data",
        "cost_per_student": "268 848 (hadde delt budsjett med Vengsøy skole fram til mars 2023 da skolen ble nedlagt)"
    },
    "Vikran skole": {
        "capacity": "Ingen data",
        "students_2023": "18",
        "students_2030": "14",
        "students_2040": "Ingen data",
        "students_2050": "Ingen data",
        "cost_per_student": "169 721"
    },
    "Langnes skole": {
        "capacity": "Ingen data",
        "students_2023": "Ingen data",
        "students_2030": "Ingen data",
        "students_2040": "Ingen data",
        "students_2050": "Ingen data",
        "cost_per_student": "Ingen data"
    }
}

# Define schools affected by the changes
schools_base_data = [
    {"name": "Lunheim skole", "status": "Stenges", "info": "Skolen legges ned", "destination": ["Krokelvdalen skole", "Tromsdalen skole"]},
    {"name": "Krokelvdalen skole", "status": "Mottar elever", "info": "Mottar elever fra Lunheim", "destination": []},
    {"name": "Tromsdalen skole", "status": "Mottar elever", "info": "Mottar elever fra Lunheim", "destination": []},
    {"name": "Trondjord skole", "status": "Stenges", "info": "Slås sammen til Kvaløysletta 1-10", "destination": ["Kvaløysletta skole"]},
    {"name": "Sandnessund skole", "status": "Stenges", "info": "Slås sammen til Kvaløysletta 1-10", "destination": ["Kvaløysletta skole"]},
    {"name": "Slettaelva skole", "status": "Stenges", "info": "Slås sammen til Kvaløysletta 1-10", "destination": ["Kvaløysletta skole"]},
    {"name": "Kvaløysletta skole", "status": "Mottar elever", "info": "Ny 1-10 skole", "destination": []},
    {"name": "Ersfjordbotn skole", "status": "Stenges", "info": "Elever flyttes til Storelva", "destination": ["Storelva skole"]},
    {"name": "Storelva skole", "status": "Mottar elever", "info": "Mottar elever fra Ersfjordbotn", "destination": []},
    {"name": "Hamna skole", "status": "Stenges", "info": "1-4: til Solneset, 5-7: til Langnes", "destination": ["Solneset skole", "Langnes skole"]},
    {"name": "Solneset skole", "status": "Omorganiseres", "info": "Mottar 1-4 fra Hamna, 5-7 til Langnes", "destination": ["Langnes skole"]},
    {"name": "Langnes skole", "status": "Mottar elever", "info": "Mottar 5-7 fra Hamna og Solneset", "destination": []},
    {"name": "Vikran skole", "status": "Stenges", "info": "Elever flyttes til Straumsbukta", "destination": ["Straumsbukta skole"]},
    {"name": "Straumsbukta skole", "status": "Mottar elever", "info": "Mottar elever fra Vikran", "destination": []},
    {"name": "Kattfjord skole", "status": "Stenges", "info": "Elever flyttes til Brensholmen", "destination": ["Brensholmen skole"]},
    {"name": "Brensholmen skole", "status": "Mottar elever", "info": "Mottar elever fra Kattfjord", "destination": []}
]

# Try to load cached coordinates
cache_file = Path('school_coordinates_cache.json')
if cache_file.exists():
    with open(cache_file, 'r', encoding='utf-8') as f:
        coordinates_cache = json.load(f)
else:
    coordinates_cache = {}

# Get coordinates for all schools
school_data = []
for school in schools_base_data:
    if school['name'] in coordinates_cache:
        lat, lon = coordinates_cache[school['name']]
    else:
        print(f"Fetching coordinates for {school['name']}...")
        coords = get_school_coordinates(school['name'])
        if coords:
            lat, lon = coords
            coordinates_cache[school['name']] = [lat, lon]
        else:
            print(f"Could not find coordinates for {school['name']}")
            continue
    
    school_data.append({
        **school,
        "lat": lat,
        "lon": lon
    })

# Save updated cache
with open(cache_file, 'w', encoding='utf-8') as f:
    json.dump(coordinates_cache, f, ensure_ascii=False, indent=2)

# Create a base map centered on Tromsø
map_tromso = folium.Map(
    location=[69.65, 18.95],
    zoom_start=10,
    tiles='cartodbpositron'
)

# Define status styles with new icons
status_styles = {
    "Stenges": {
        "color": "red",
        "icon": """
        <div style="position: relative; width: 40px; height: 40px; text-align: center;">
            <i class="fa fa-school fa-2x" style="color: #e74c3c; opacity: 0.85;"></i>
        </div>
        """
    },
    "Mottar elever": {
        "color": "green",
        "icon": """
        <div style="position: relative; width: 40px; height: 40px; text-align: center;">
            <i class="fa fa-school fa-2x" style="color: #27ae60; opacity: 0.85;"></i>
        </div>
        """
    },
    "Omorganiseres": {
        "color": "blue",
        "icon": """
        <div style="position: relative; width: 40px; height: 40px; text-align: center;">
            <i class="fa fa-school fa-2x" style="color: #2980b9; opacity: 0.85;"></i>
            <i class="fa fa-refresh" style="position: absolute; top: -5px; right: -5px; color: #2980b9; font-size: 12px; text-shadow: 1px 1px 2px white;"></i>
        </div>
        """
    }
}

# Create layer groups for different types of schools
layer_groups = {
    status: folium.FeatureGroup(name=f"Skoler som {status.lower()}")
    for status in status_styles.keys()
}
flytting_group = folium.FeatureGroup(name="Flytting av elever")

# Define valid school transitions
valid_transitions = {
    "Lunheim skole": ["Krokelvdalen skole", "Tromsdalen skole"],
    "Trondjord skole": ["Kvaløysletta skole"],
    "Sandnessund skole": ["Kvaløysletta skole"],
    "Slettaelva skole": ["Kvaløysletta skole"],
    "Ersfjordbotn skole": ["Storelva skole"],
    "Hamna skole": ["Solneset skole", "Langnes skole"],  # Both destinations
    "Solneset skole": ["Langnes skole"],
    "Vikran skole": ["Straumsbukta skole"],
    "Kattfjord skole": ["Brensholmen skole"]
}

# Initialize bundled_routes dictionary
bundled_routes = {}

# First add school routes to bundled_routes - only for valid transitions
for school in school_data:
    if school["name"] in valid_transitions:
        for destination in valid_transitions[school["name"]]:
            dest_school = next((s for s in school_data if s["name"] == destination), None)
            if dest_school:
                # Get route coordinates
                route_data = get_route_coordinates(
                    school["lat"], school["lon"],
                    dest_school["lat"], dest_school["lon"]
                )
                
                if route_data:
                    # Determine route color based on type
                    route_color = "#006D77"  # Default teal for school routes
                    if school.get("type") == "village":
                        route_color = "#E29578"  # Coral color for village routes
                    
                    # Store route for bundling
                    if destination not in bundled_routes:
                        bundled_routes[destination] = []
                    
                    # Add extra info for Hamna and Solneset routes
                    tooltip_extra = ""
                    if school["name"] == "Hamna skole":
                        if destination == "Solneset skole":
                            tooltip_extra = " (1.-4. trinn)"
                            # Also add this route to Langnes bundle since it's part of the complete path
                            if "Langnes skole" not in bundled_routes:
                                bundled_routes["Langnes skole"] = []
                            bundled_routes["Langnes skole"].append({
                                "from": school["name"],
                                "route": route_data,
                                "color": "#006D77",
                                "type": "school",
                                "tooltip_extra": tooltip_extra,
                                "is_first_leg": True  # Mark this as first leg of the journey
                            })
                        elif destination == "Langnes skole":
                            tooltip_extra = " (5.-7. trinn)"
                            # Also add this route to Solneset bundle for completeness
                            if "Solneset skole" not in bundled_routes:
                                bundled_routes["Solneset skole"] = []
                            bundled_routes["Solneset skole"].append({
                                "from": school["name"],
                                "route": route_data,
                                "color": "#006D77",
                                "type": "school",
                                "tooltip_extra": tooltip_extra,
                                "is_second_leg": True  # Mark this as second leg of the journey
                            })
                    elif school["name"] == "Solneset skole" and destination == "Langnes skole":
                        tooltip_extra = " (5.-7. trinn)"
                    
                    bundled_routes[destination].append({
                        "from": school["name"],
                        "route": route_data,
                        "color": route_color,  # Use the determined color
                        "type": "school" if school.get("type") != "village" else "village",
                        "tooltip_extra": tooltip_extra
                    })

# Add school markers with permanent labels to their respective layer groups
for school in school_data:
    # Create enhanced popup with HTML formatting
    popup_html = f"""
    <div style="
        width: 280px;
        font-family: 'Segoe UI', Arial, sans-serif;
        padding: 10px;
        border-radius: 8px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    ">
        <h4 style="
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            color: #2c3e50;
            font-size: 18px;
        ">{school["name"]}</h4>
        
        <div style="
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        ">
            <p style="
                margin: 5px 0;
                color: #2c3e50;
                font-weight: bold;
            ">Status: <span style="font-weight: normal;">{school["status"]}</span></p>
            <p style="
                margin: 5px 0;
                color: #2c3e50;
                font-weight: bold;
            ">Info: <span style="font-weight: normal;">{school["info"]}</span></p>
        </div>
    """
    
    # Add statistics if available
    if school["name"] in school_stats:
        stats = school_stats[school["name"]]
        popup_html += f"""
        <div style="
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        ">
            <p style="margin: 0 0 10px 0; font-weight: bold; color: #2c3e50; font-size: 14px;">Skoledata:</p>
            
            <div style="
                display: grid;
                grid-template-columns: auto 1fr;
                gap: 8px;
                font-size: 13px;
            ">
                <span style="color: #666;">Kapasitet:</span>
                <span style="color: #2c3e50;">{stats["capacity"]}</span>
                
                <span style="color: #666;">Elever 2023:</span>
                <span style="color: #2c3e50;">{stats["students_2023"]}</span>
                
                <span style="color: #666;">Elever 2030:</span>
                <span style="color: #2c3e50;">{stats["students_2030"]}</span>
                
                <span style="color: #666;">Elever 2040:</span>
                <span style="color: #2c3e50;">{stats["students_2040"]}</span>
                
                <span style="color: #666;">Elever 2050:</span>
                <span style="color: #2c3e50;">{stats["students_2050"]}</span>
            </div>
            
            <div style="
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid #dee2e6;
                font-size: 13px;
            ">
                <span style="color: #666;">Kostnad per elev:</span>
                <span style="color: #2c3e50; display: block; margin-top: 4px;">{stats["cost_per_student"]}</span>
            </div>
        </div>
        """
    
    popup_html += "</div>"
    
    # Add marker with custom icon
    folium.Marker(
        location=[school["lat"], school["lon"]],
        popup=folium.Popup(popup_html, max_width=300),
        icon=folium.DivIcon(
            html=status_styles[school["status"]]["icon"],
            icon_size=(40, 40),
            icon_anchor=(20, 20)
        ),
        tooltip=f"{school['name']} - {school['status']}",
        popup_anchor=(0, -20)
    ).add_to(layer_groups[school["status"]])
    
    # Add permanent label with improved styling
    folium.Marker(
        [school["lat"], school["lon"]],
        icon=folium.DivIcon(
            html=f'''
                <div style="
                    font-size: 12px;
                    font-weight: bold;
                    color: #2c3e50;
                    text-shadow: 
                        2px 2px 3px white,
                        -2px 2px 3px white,
                        2px -2px 3px white,
                        -2px -2px 3px white;
                    position: relative;
                    top: 20px;
                    width: 120px;
                    text-align: center;
                    left: -60px;
                ">
                    {school["name"]}
                </div>
            ''',
            icon_size=(120, 20)
        )
    ).add_to(layer_groups[school["status"]])

# Add village locations and their routes
village_data = [
    {
        "name": "Kvaløyvågen",
        "color": "#8B4513",  # Saddle brown
        "current_school": "Trondjord skole",
        "future_school": "Kvaløysletta skole"
    },
    {
        "name": "Tromvik",
        "color": "#FFA500",  # Orange
        "current_school": "Ersfjordbotn skole",
        "future_school": "Storelva skole"
    },
    {
        "name": "Vasstrand",
        "color": "#9370DB",  # Purple
        "current_school": "Kattfjord skole",
        "future_school": "Brensholmen skole"
    },
    {
        "name": "Indre Kårvik",
        "color": "#4682B4",  # Steel blue
        "current_school": None,  # No line to current school
        "popup_current_school": "Trondjord skole",  # For popup info only
        "future_school": "Kvaløysletta skole"
    },
    {
        "name": "Brokskar",
        "color": "#20B2AA",  # Light sea green
        "current_school": "Vikran skole",
        "future_school": "Straumsbukta skole"
    }
]

# Create a feature group for villages
villages_group = folium.FeatureGroup(name="Bygder")

# List to store routes to current schools
routes_to_current_schools = []

# Process village routes
for village in village_data:
    # Get coordinates from cache or fetch new ones
    if village["name"] in coordinates_cache:
        coords = coordinates_cache[village["name"]]
        village_coords = [coords["lat"], coords["lon"]]
    else:
        coords = get_school_coordinates(village["name"])
        if coords:
            village_coords = coords
            coordinates_cache[village["name"]] = {"lat": coords[0], "lon": coords[1]}
        else:
            print(f"Could not get coordinates for {village['name']}")
            continue

    # Create house icon and add village marker
    house_icon = f"""
    <div style="opacity: 0.85;">
        <i class="fa fa-home fa-2x" style="color: {village['color']};"></i>
    </div>
    """
    
    # Create popup content
    popup_html = f"""
    <div style="
        width: 280px;
        font-family: 'Segoe UI', Arial, sans-serif;
        padding: 10px;
        border-radius: 8px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    ">
        <h4 style="
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            color: #2c3e50;
            font-size: 18px;
        ">{village["name"]}</h4>
        
        <div style="
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        ">
    """
    
    if village.get('popup_current_school') or village.get('current_school'):
        popup_html += f"""
            <p style="
                margin: 5px 0;
                color: #2c3e50;
            ">
                <strong>I dag:</strong> Elevene går på {village.get('popup_current_school') or village.get('current_school', 'Ingen')}
            </p>
            <p style="
                margin: 5px 0;
                color: #2c3e50;
            ">
                <strong>Etter omorganisering:</strong> Elevene skal gå på {village["future_school"]}
            </p>
        """
    else:  # For villages without current school
        popup_html += f"""
            <p style="
                margin: 5px 0;
                color: #2c3e50;
            ">
                Elevene skal gå på {village["future_school"]} etter omorganiseringen
            </p>
        """
    
    popup_html += """
        </div>
    </div>
    """
    
    # Add village marker
    folium.Marker(
        location=village_coords,
        icon=folium.DivIcon(
            html=house_icon,
            icon_size=(40, 40),
            icon_anchor=(20, 20)
        ),
        popup=folium.Popup(popup_html, max_width=300),
        tooltip=village["name"]
    ).add_to(villages_group)
    
    # Add village label
    folium.Marker(
        location=village_coords,
        icon=folium.DivIcon(
            html=f'''
                <div style="
                    font-size: 12px;
                    font-weight: bold;
                    color: #2c3e50;
                    text-shadow: 
                        2px 2px 3px white,
                        -2px 2px 3px white,
                        2px -2px 3px white,
                        -2px -2px 3px white;
                    position: relative;
                    top: 20px;
                    width: 120px;
                    text-align: center;
                    left: -60px;
                ">
                    {village["name"]}
                </div>
            ''',
            icon_size=(120, 20)
        )
    ).add_to(villages_group)

    # Draw route to current school (solid line)
    if village.get('current_school'):  # For all except Indre Kårvik
        current_school = next((s for s in school_data if s["name"] == village["current_school"]), None)
        if current_school:
            route = get_route_coordinates(
                village_coords[0], village_coords[1],
                current_school["lat"], current_school["lon"]
            )
            if route:
                points = [[lat, lon] for lon, lat in route["coordinates"]]
                village_tooltip = f'<div style="width: 100%; word-wrap: break-word; overflow-wrap: break-word;">Elever fra {village["name"]} → {village["current_school"]}<br>Kjøretid: {route["duration"]} minutter<br>Avstand: {route["distance"]} km</div>'
                plugins.AntPath(
                    locations=points,
                    delay=2000,
                    weight=5,
                    color=village["color"],
                    pulse_color='#FFF',
                    tooltip=village_tooltip,
                    options={
                        'interactive': True,
                        'bubblingMouseEvents': False,
                        'highlightStyle': {
                            'weight': 6,
                            'opacity': 1,
                            'color': village["color"]
                        }
                    }
                ).add_to(flytting_group)

    # Store route to future school for bundling (dashed line)
    future_school = next((s for s in school_data if s["name"] == village["future_school"]), None)
    if future_school:
        # Always start from the village location, not the current school
        route = get_route_coordinates(
            village_coords[0], village_coords[1],  # Start from village
            future_school["lat"], future_school["lon"]  # End at future school
        )
        if route:
            if village["future_school"] not in bundled_routes:
                bundled_routes[village["future_school"]] = []
            bundled_routes[village["future_school"]].append({
                "from": village["name"],
                "route": route,
                "color": village["color"],
                "type": "village",  # Mark as village route
                "tooltip_extra": ""  # Add any extra tooltip info
            })

# Draw bundled routes to future schools (dashed lines)
for destination, routes in bundled_routes.items():
    # Create combined tooltip showing all travel times
    tooltip_parts = []
    
    # First add school routes to tooltip
    # Sort routes so that first leg comes before second leg
    school_routes = [r for r in routes if r.get('type') == 'school']
    school_routes.sort(key=lambda x: (x.get('is_second_leg', False), x.get('from')))
    
    for route_info in school_routes:
        # Skip second leg routes when showing Solneset tooltip
        if destination == "Solneset skole" and route_info.get('is_second_leg'):
            continue
        tooltip_parts.append(
            f'Elever fra {route_info["from"]}{route_info.get("tooltip_extra", "")} → {destination}<br>Kjøretid: {route_info["route"]["duration"]} minutter<br>Avstand: {route_info["route"]["distance"]} km'
        )
    
    # Then add village routes to tooltip
    for route_info in [r for r in routes if r.get('type') == 'village']:
        tooltip_parts.append(
            f'Elever fra {route_info["from"]} → {destination}<br>Kjøretid: {route_info["route"]["duration"]} minutter<br>Avstand: {route_info["route"]["distance"]} km'
        )
    
    # Draw all routes in the bundle
    for route_info in routes:
        points = [[lat, lon] for lon, lat in route_info["route"]["coordinates"]]
        
        # Calculate center point for this route
        center_lat = sum(p[0] for p in points) / len(points)
        center_lon = sum(p[1] for p in points) / len(points)
        
        # Create tooltip content with map centering on hover
        if destination == "Langnes skole" or destination == "Solneset skole" or len(routes) > 1:
            # For Langnes, Solneset, or bundled routes, show all related routes
            tooltip_content = '<br><br>'.join(tooltip_parts)
        else:
            # For individual routes, show just this route
            tooltip_content = (
                f'Elever fra {route_info["from"]}{route_info.get("tooltip_extra", "")} → {destination}<br>'
                f'Kjøretid: {route_info["route"]["duration"]} minutter<br>'
                f'Avstand: {route_info["route"]["distance"]} km'
            )
        
        # Create the tooltip HTML with centering functionality
        tooltip = (
            f'<div class="leaflet-tooltip" style="'
            f'min-width: 280px; '
            f'max-width: min(280px, calc(100vw - 40px)); '
            f'font-family: \'Segoe UI\', Arial, sans-serif; '
            f'padding: 10px; '
            f'border-radius: 6px; '
            f'background: rgba(255, 255, 255, 0.9); '
            f'box-shadow: 0 2px 4px rgba(0,0,0,0.1); '
            f'font-size: 13px; '
            f'line-height: 1.4; '
            f'onmouseover="window._map.setView([{center_lat}, {center_lon}], 13);" '
            f'onclick="window._map.setView([{center_lat}, {center_lon}], 13);" '
            f'ontouchstart="window._map.setView([{center_lat}, {center_lon}], 13);">'
            f'{tooltip_content}</div>'
        )
        
        # Draw the route
        plugins.AntPath(
            locations=points,
            delay=2000,
            weight=8 if len(routes) > 1 or destination in ["Langnes skole", "Solneset skole"] else 5,  # Thicker for bundled/multi-destination routes
            color=route_info["color"],  # Use the route's assigned color
            pulse_color='#FFF',
            dash_array=[10, 20],  # Dashed line for future routes
            tooltip=tooltip,
            options={
                'interactive': True,
                'bubblingMouseEvents': True,  # Allow hover events to bubble up
                'highlightStyle': {
                    'weight': 9 if len(routes) > 1 or destination in ["Langnes skole", "Solneset skole"] else 6,
                    'opacity': 1,
                    'color': route_info["color"]  # Use the route's assigned color for highlighting
                }
            }
        ).add_to(flytting_group)

# Add villages group to map
villages_group.add_to(map_tromso)

# Add all layer groups to the map
for layer in layer_groups.values():
    layer.add_to(map_tromso)
flytting_group.add_to(map_tromso)

# Add custom CSS for mobile-friendly tooltips and lines with dark mode support
css = """
<style>
/* Light mode styles (default) */
:root {
    --tooltip-bg: rgba(255, 255, 255, 0.9);
    --tooltip-text: #2c3e50;
    --tooltip-border: none;
    --tooltip-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Dark mode styles */
@media (prefers-color-scheme: dark) {
    :root {
        --tooltip-bg: rgba(33, 33, 33, 0.95);
        --tooltip-text: #ffffff;
        --tooltip-border: 1px solid rgba(255, 255, 255, 0.1);
        --tooltip-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    /* Dark mode specific map adjustments */
    .leaflet-container {
        background-color: #242424 !important;
    }
    
    .leaflet-tile {
        filter: brightness(0.8) contrast(1.2) invert(1) hue-rotate(180deg);
    }
    
    .leaflet-control-layers,
    .leaflet-control-zoom {
        background-color: #333 !important;
        border-color: #444 !important;
    }
    
    .leaflet-control-layers-toggle,
    .leaflet-control-zoom-in,
    .leaflet-control-zoom-out {
        background-color: #333 !important;
        color: #fff !important;
        border-color: #444 !important;
    }
    
    .leaflet-popup-content-wrapper {
        background-color: var(--tooltip-bg);
        color: var(--tooltip-text);
    }
    
    .leaflet-popup-tip {
        background-color: var(--tooltip-bg);
    }
}

.leaflet-tooltip {
    background: var(--tooltip-bg);
    border: var(--tooltip-border);
    border-radius: 6px;
    padding: 8px 12px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    font-size: 13px;
    line-height: 1.4;
    box-shadow: var(--tooltip-shadow);
    width: auto;
    max-width: 250px;
    white-space: normal !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    color: var(--tooltip-text);
}

.leaflet-tooltip h4,
.leaflet-tooltip p {
    color: var(--tooltip-text);
}

.leaflet-tooltip:before {
    display: none;
}

@media (max-width: 768px) {
    .leaflet-tooltip {
        max-width: 200px;
        font-size: 12px;
        padding: 6px 10px;
    }

    /* Increase line weights on mobile */
    .leaflet-ant-path {
        stroke-width: 7px !important;
    }
    
    .leaflet-interactive:hover {
        stroke-width: 7px !important;
    }
}

.leaflet-container {
    -webkit-tap-highlight-color: transparent;
}

.leaflet-interactive {
    outline: none !important;
}

.transparent-label {
    background: transparent;
    border: 0;
    font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
}

/* Dark mode adjustments for controls */
@media (prefers-color-scheme: dark) {
    .leaflet-control-layers-expanded {
        background-color: var(--tooltip-bg) !important;
        color: var(--tooltip-text) !important;
    }
    
    .leaflet-control-layers label {
        color: var(--tooltip-text) !important;
    }
    
    .leaflet-control-attribution {
        background-color: rgba(33, 33, 33, 0.8) !important;
        color: #ccc !important;
    }
    
    .leaflet-control-attribution a {
        color: #9ca3af !important;
    }
}
</style>
"""
map_tromso.get_root().html.add_child(folium.Element(css))

# Add layer control and fullscreen option
folium.LayerControl().add_to(map_tromso)
plugins.Fullscreen().add_to(map_tromso)

# Save the map to an HTML file with timestamp
timestamp = datetime.now().strftime("%Y%m%d_%H%M")
output_file = f"tromso_school_changes_{timestamp}.html"
map_tromso.save(output_file)
print(f"Map saved as: {output_file}")

# Display the map
map_tromso
